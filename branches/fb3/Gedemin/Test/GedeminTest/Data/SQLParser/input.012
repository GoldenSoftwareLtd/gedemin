 select 
  t.id, t.lb, t.rb,  
  c.alias, c1.alias, 
  t.name, doc.documentdate, doc.number, r.entrydate, 
 SUM(IIF(R1.id IS NULL, R.DEBITNCU, iif (R1.issimple = 1, iif(r.id is null, R1.creditncu, R.DEBITNCU), R1.creditncu))) as SUMNCU 
  from AC_TRANSACTION T 
    JOIN AC_RECORD Z ON T.ID  =  Z.TRANSACTIONKEY 
    LEFT JOIN AC_ENTRY R ON Z.ID = R.RECORDKEY AND r.debitncu <> 0 
    LEFT JOIN AC_ACCOUNT C ON R.ACCOUNTKEY = C.ID 
    LEFT JOIN AC_ENTRY R1 ON Z.ID = R1.RECORDKEY AND r1.creditncu <> 0 
    LEFT JOIN AC_ACCOUNT C1 ON R1.ACCOUNTKEY = C1.ID 
    LEFT JOIN  GD_DOCUMENT DOC ON Z.DOCUMENTKEY  =  DOC.ID  LEFT JOIN GD_TAX as R_USR$MGAZ_NALOGI ON  R.USR$MGAZ_NALOGI = R_USR$MGAZ_NALOGI.ID
 LEFT JOIN GD_CONTACT as R_USR$GS_CUSTOMER ON  R.USR$GS_CUSTOMER = R_USR$GS_CUSTOMER.ID
 LEFT JOIN GD_CONTACT as R_USR$GS_DEPARTMENT ON  R.USR$GS_DEPARTMENT = R_USR$GS_DEPARTMENT.ID
 LEFT JOIN GD_GOOD as R_USR$GS_GOOD ON  R.USR$GS_GOOD = R_USR$GS_GOOD.ID
 LEFT JOIN GD_DOCUMENT as R_USR$GS_DOCUMENT ON  R.USR$GS_DOCUMENT = R_USR$GS_DOCUMENT.ID
 LEFT JOIN GD_GOOD as R_USR$GS_SERVICE ON  R.USR$GS_SERVICE = R_USR$GS_SERVICE.ID
 LEFT JOIN GD_CONTACT as R_USR$GS_EMPLOYEE ON  R.USR$GS_EMPLOYEE = R_USR$GS_EMPLOYEE.ID
 LEFT JOIN USR$INV_CAR as R_USR$BTE_CARKEY ON  R.USR$BTE_CARKEY = R_USR$BTE_CARKEY.ID
 LEFT JOIN USR$VATTYPES as R_USR$VATTYPE_KEY ON  R.USR$VATTYPE_KEY = R_USR$VATTYPE_KEY.ID
 LEFT JOIN USR$MGAZ_GAZ as R_USR$MGAZKEY ON  R.USR$MGAZKEY = R_USR$MGAZKEY.ID
 LEFT JOIN GD_GOOD as R_USR$REN_OBJECTKEY ON  R.USR$REN_OBJECTKEY = R_USR$REN_OBJECTKEY.ID
 LEFT JOIN USR$VIDRASHODOV as R_USR$RASHOD ON  R.USR$RASHOD = R_USR$RASHOD.ID
 LEFT JOIN USR$ACC_EXPENSES as R_USR$GS_EXPENSES ON  R.USR$GS_EXPENSES = R_USR$GS_EXPENSES.ID
 LEFT JOIN USR$MGAZ_STATYICFO as R_USR$MGAZ_CFO ON  R.USR$MGAZ_CFO = R_USR$MGAZ_CFO.ID
 LEFT JOIN USR$MGAZ_ACTIONS as R_USR$MGAZ_ACTION ON  R.USR$MGAZ_ACTION = R_USR$MGAZ_ACTION.ID
 LEFT JOIN USR$MGAZ_KINDWORK as R_USR$MGAZ_KINDWORK ON  R.USR$MGAZ_KINDWORK = R_USR$MGAZ_KINDWORK.ID
 LEFT JOIN GD_TAX as R1_USR$MGAZ_NALOGI ON  R1.USR$MGAZ_NALOGI = R1_USR$MGAZ_NALOGI.ID
 LEFT JOIN GD_CONTACT as R1_USR$GS_CUSTOMER ON  R1.USR$GS_CUSTOMER = R1_USR$GS_CUSTOMER.ID
 LEFT JOIN GD_CONTACT as R1_USR$GS_DEPARTMENT ON  R1.USR$GS_DEPARTMENT = R1_USR$GS_DEPARTMENT.ID
 LEFT JOIN GD_GOOD as R1_USR$GS_GOOD ON  R1.USR$GS_GOOD = R1_USR$GS_GOOD.ID
 LEFT JOIN GD_DOCUMENT as R1_USR$GS_DOCUMENT ON  R1.USR$GS_DOCUMENT = R1_USR$GS_DOCUMENT.ID
 LEFT JOIN GD_GOOD as R1_USR$GS_SERVICE ON  R1.USR$GS_SERVICE = R1_USR$GS_SERVICE.ID
 LEFT JOIN GD_CONTACT as R1_USR$GS_EMPLOYEE ON  R1.USR$GS_EMPLOYEE = R1_USR$GS_EMPLOYEE.ID
 LEFT JOIN USR$INV_CAR as R1_USR$BTE_CARKEY ON  R1.USR$BTE_CARKEY = R1_USR$BTE_CARKEY.ID
 LEFT JOIN USR$VATTYPES as R1_USR$VATTYPE_KEY ON  R1.USR$VATTYPE_KEY = R1_USR$VATTYPE_KEY.ID
 LEFT JOIN USR$MGAZ_GAZ as R1_USR$MGAZKEY ON  R1.USR$MGAZKEY = R1_USR$MGAZKEY.ID
 LEFT JOIN GD_GOOD as R1_USR$REN_OBJECTKEY ON  R1.USR$REN_OBJECTKEY = R1_USR$REN_OBJECTKEY.ID
 LEFT JOIN USR$VIDRASHODOV as R1_USR$RASHOD ON  R1.USR$RASHOD = R1_USR$RASHOD.ID
 LEFT JOIN USR$ACC_EXPENSES as R1_USR$GS_EXPENSES ON  R1.USR$GS_EXPENSES = R1_USR$GS_EXPENSES.ID
 LEFT JOIN USR$MGAZ_STATYICFO as R1_USR$MGAZ_CFO ON  R1.USR$MGAZ_CFO = R1_USR$MGAZ_CFO.ID
 LEFT JOIN USR$MGAZ_ACTIONS as R1_USR$MGAZ_ACTION ON  R1.USR$MGAZ_ACTION = R1_USR$MGAZ_ACTION.ID
 LEFT JOIN USR$MGAZ_KINDWORK as R1_USR$MGAZ_KINDWORK ON  R1.USR$MGAZ_KINDWORK = R1_USR$MGAZ_KINDWORK.ID
 WHERE t.lb >= :lb and t.rb <= :rb and doc.documentdate >= :Bdate 
 and doc.documentdate <= :Edate 
  GROUP BY  t.id, t.lb, t.rb, 
 C.ALIAS, C1.alias, 
 t.name, doc.documentdate, doc.number, r.entrydate  
, R.USR$REN_TERM, R1.USR$REN_TERM
, R_USR$MGAZ_NALOGI.NAME, R1_USR$MGAZ_NALOGI.NAME
, R_USR$GS_CUSTOMER.NAME, R1_USR$GS_CUSTOMER.NAME
, R_USR$GS_DEPARTMENT.NAME, R1_USR$GS_DEPARTMENT.NAME
, R_USR$GS_GOOD.NAME, R1_USR$GS_GOOD.NAME
, R_USR$GS_DOCUMENT.NUMBER, R1_USR$GS_DOCUMENT.NUMBER
, R_USR$GS_SERVICE.NAME, R1_USR$GS_SERVICE.NAME
, R_USR$GS_EMPLOYEE.NAME, R1_USR$GS_EMPLOYEE.NAME
, R_USR$BTE_CARKEY.USR$FULLNAME, R1_USR$BTE_CARKEY.USR$FULLNAME
, R_USR$VATTYPE_KEY.USR$NAME, R1_USR$VATTYPE_KEY.USR$NAME
, R_USR$MGAZKEY.USR$NUMBER, R1_USR$MGAZKEY.USR$NUMBER
, R_USR$REN_OBJECTKEY.NAME, R1_USR$REN_OBJECTKEY.NAME
, R_USR$RASHOD.USR$NAMERASHOD, R1_USR$RASHOD.USR$NAMERASHOD
, R_USR$GS_EXPENSES.USR$NAME, R1_USR$GS_EXPENSES.USR$NAME
, R_USR$MGAZ_CFO.USR$NAMECFO, R1_USR$MGAZ_CFO.USR$NAMECFO
, R_USR$MGAZ_ACTION.USR$NAME, R1_USR$MGAZ_ACTION.USR$NAME
, R_USR$MGAZ_KINDWORK.USR$NAME, R1_USR$MGAZ_KINDWORK.USR$NAME
  ORDER BY doc.number 