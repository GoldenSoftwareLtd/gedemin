
@echo off
setlocal

echo *************************************************
echo **                                             **
echo **  Инициализируем глобальные переменные       **
echo **                                             **
echo *************************************************

set path=c:\program files\firebird 2.5\bin;C:\Program Files\Borland\Delphi5\Bin;c:\program files\StarBase\StarTeam 5.3;c:\windows;c:\windows\system32;c:\windows\System32\Wbem

set gedemin_path=..\..
set install_source_path=..\..\..\gedemin_local_fb
set setting_source_path=d:\golden\setting
rem set install_target_path=\Distrib2\GoldSoft\Gedymin\Local
set install_target_path=\distr_temp

set exit_code=0
set exit_message=0

echo *************************************************
echo **                                             **
echo **  Выгружаем настройки из StarTeam            **
echo **                                             **
echo *************************************************

set starteam_path=c:\program files\StarBase\StarTeam 5.3
set starteam_connect=Andreik:1@india:49201

"%starteam_path%\stcmd.exe" co -p "%starteam_connect%/Setting" -is -x -stop -f NCO -nologo -q
if errorlevel 0 goto CompileGedemin

set exit_code=100
set exit_message="Error while checking out files"
goto Exit

:CompileGedemin

echo *************************************************
echo **                                             **
echo **  Компилируем gedemin.exe                    **
echo **                                             **
echo *************************************************

cd ..\..\exe
call update_gedemin.bat /no_ftp
cd ..\setup\bootstrap

if not errorlevel 0 goto Error

echo *************************************************
echo **                                             **
echo **  Копируем gedemin.exe                       **
echo **                                             **
echo *************************************************

copy ..\..\exe\gedemin.exe %install_source_path%\gedemin.exe /Y
if not errorlevel 0 goto Error

echo *************************************************
echo **                                             **
echo **  Делаем инстоляции                          **
echo **                                             **
echo *************************************************

call make_install.bat "%setting_source_path%\Банк\Банк и касса.gsf"                                         plat      doc.jpg     platlocal     plat_setup.rar  "%install_target_path%\Платежные документы\setup.exe" 
call make_install.bat "%setting_source_path%\Общие\Общие данные.gsf"                                        devel     complex.jpg devellocal    devel_setup.rar "%install_target_path%\Разработчик\setup.exe" 
call make_install.bat "%setting_source_path%\Общие\Комплексная_автоматизация.gsf"                           business  complex.jpg businesslocal compl_setup.rar "%install_target_path%\Комплексная автоматизация\setup.exe" 
call make_install.bat "%setting_source_path%\Предприниматель\Подоходный\Предприниматель_подоходный.gsf"     ip        ip.jpg      iplocal       ip_setup.rar    "%install_target_path%\Предприниматель\setup.exe" 
call make_install.bat "%setting_source_path%\Предприниматель\Единый налог\Предприниматель_единый_налог.gsf" ip        ip.jpg      iplocal       ip_setup_ed.rar "%install_target_path%\Предприниматель\setup_ed.exe" 

if not errorlevel 0 goto Error

goto Exit

:Error

echo *************************************************
echo **                                             **
echo **  Произошла ошибка!                          **
echo **                                             **
echo *************************************************

set exit_code=200
set exit_message="Unknown error"
goto Exit

:Exit

if not %exit_code%==0 eventcreate /t error /id %exit_code% /l application /so gedemin /d %exit_message%
if not %exit_code%==0 exit /b %exit_code%

endlocal